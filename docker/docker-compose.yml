version: '3.8'

networks:
  web:
    external: true
  internal:
    external: false
  vpn-network:
    driver: bridge
    ipam:
      config:
        - subnet: 10.8.0.0/24

services:
  traefik:
    image: traefik:v2.10
    container_name: traefik
    restart: unless-stopped
    command:
      - "--configFile=/etc/traefik/traefik.yaml"
    ports:
      - "8080:8080"  # Dashboard
      - "8081:8081"  # HTTP for VPN
      - "8443:8443"  # HTTPS for VPN
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik:/etc/traefik
      - ./traefik/certs:/certs
    networks:
      - web
      - vpn-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=Host(`traefik.aformulationoftruth.com`)"
      - "traefik.http.routers.traefik.tls=true"
      - "traefik.http.routers.traefik.service=api@internal"

  wg-easy:
    image: ghcr.io/wg-easy/wg-easy:latest
    container_name: wg-easy
    restart: unless-stopped
    environment:
      - WG_HOST=37.228.129.173
      - PASSWORD_HASH=$$2a$$10$$e/pZ4daGeA.DgT5yFAWdQ.mKcV62hqRxY5zg5xeY7/hrnl8VRRuim
      - WG_PORT=51820
      - WG_DEFAULT_ADDRESS=10.8.0.x
      - WG_DEFAULT_DNS=37.156.68.20,185.247.225.17,185.246.188.51,2a06:1700:100:20::1,2a06:1700:0:36::1,2a06:1700:3:11::1
      - WG_MTU=1420
      - WG_PERSISTENT_KEEPALIVE=25
      - WG_PRE_UP=echo "WireGuard Pre-Up"
      - WG_POST_UP=iptables -A FORWARD -i %i -j ACCEPT; iptables -A FORWARD -o %i -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
      - WG_PRE_DOWN=echo "WireGuard Pre-Down"
      - WG_POST_DOWN=iptables -D FORWARD -i %i -j ACCEPT; iptables -D FORWARD -o %i -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE
    volumes:
      - wg-easy-data:/etc/wireguard
    ports:
      - "51820:51820/udp"  # WireGuard port
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv4.conf.all.src_valid_mark=1
    networks:
      - vpn-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.wg-easy.rule=Host(`vpn.aformulationoftruth.com`)"
      - "traefik.http.routers.wg-easy.entrypoints=vpn-web"
      - "traefik.http.services.wg-easy.loadbalancer.server.port=51821"
      - "traefik.docker.network=vpn-network"

  pyazopay:
    image: osminogin/tor-simple:latest
    container_name: pyazopay
    restart: unless-stopped
    volumes:
      - ./pyaz/torrc:/etc/tor/torrc:ro
      - ./pyaz/hidden_service:/var/lib/tor/hidden_service
      - ./pyaz/data:/var/lib/tor/data
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETUID
      - SETGID
      - DAC_OVERRIDE
    security_opt:
      - no-new-privileges:true
    networks:
      - internal

  karuppacami-frontend:
    profiles:
      - web
    build:
      context: ../frontend
    container_name: karuppacami-frontend
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=5742
      - REACT_APP_API_URL=http://karuppacami-backend:3001
    networks:
      - web
      - internal
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.karuppacami.rule=Host(`aformulationoftruth.com`) || Host(`www.aformulationoftruth.com`)"
      - "traefik.http.routers.karuppacami.entrypoints=web,websecure"
      - "traefik.http.routers.karuppacami.tls=true"
      - "traefik.http.routers.karuppacami.tls.certresolver=letsencrypt"
      - "traefik.http.services.karuppacami.loadbalancer.server.port=5742"
      - "traefik.docker.network=web"

  karuppacami-backend:
    profiles:
      - web
    build:
      context: ../backend
    container_name: karuppacami-backend
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=3001
      - DATABASE_URL=postgresql://a4m_app:jsT@sA2nd1nsd3cl2y0@185.146.234.144:5432/a4m_db
      - DB_HOST=185.146.234.144
      - DB_PORT=5432
      - DB_NAME=a4m_db
      - DB_USER=a4m_app
      - DB_PASSWORD=jsT@sA2nd1nsd3cl2y0
      - JWT_SECRET=+Rw+suiD3UdO7++JahQMGpnYf5DkQPeum/uwidNbma2Nh4q0xOvNubZo4BbjHvmj1JER2gmrY5ogLzyZcjCUYQ==
      - SENDGRID_API_KEY=SG.XXXXXXXXXXXXXXXXXXXX.XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
      - SENDGRID_FROM_EMAIL=noreply@aformulationoftruth.com
      - SENDGRID_FROM_NAME=A Formulation of Truth
      - SMTP_HOST=smtp.mail.me.com
      - SMTP_PORT=587
      - SMTP_SECURE=false
      - SMTP_USER=nyagrodha@icloud.com
      - SMTP_PASS=ofch-wrgg-yjtb-ukrv
      - FROM_EMAIL=formitselfisemptiness@aformulationoftruth.con
      - FROM_NAME=Karuppacāmi Nirmeyappōr
      - ADMIN_EMAIL=marcel@aformulationoftruth.com
      - TWILIO_ACCOUNT_SID=ACXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
      - TWILIO_AUTH_TOKEN=fe68e5d3276f3f68b3ce06eefcd5bc72
    volumes:
      - ../backend/data:/app/data
    networks:
      - web
      - internal
    labels:
      - "traefik.enable=false"

volumes:
  wg-easy-data:
    driver: local
