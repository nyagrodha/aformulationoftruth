<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>a formulation of truth</title>
    <meta name="description" content="a formulation of truth. Self-inquiry and a Proust Questionnaire.">

    <!-- Open Graph / Twitter -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://aformulationoftruth.com/">
    <meta property="og:title" content="a formulation of truth">
    <meta property="og:description" content="here, a device: the ƒÅtmanoptican as a formulation of truth. Self-inquiry and a Proust Questionnaire.">
    <meta property="og:image" content="https://aformulationoftruth.com/images/dreamMore...always.JPG">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://aformulationoftruth.com/">
    <meta name="twitter:title" content="a formulation of truth: a slow experiment">
    <meta name="twitter:description" content="here, a device: the ƒÅtmanoptican as a formulation of truth.">
    <meta name="twitter:image" content="https://aformulationoftruth.com/images/dreamMore...always.JPG">

    <!-- Favicons -->
    <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-simple-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-simple-16.png">

    <!-- Styles -->
    <link rel="stylesheet" href="/css/index_style.css">
</head>
<body>
    <a href="#begin" class="skip-link">Skip to questionnaire</a>
    <nav>
       <!-- <a href="/" class="logo">A4T</a> -->
        <div class="nav-links">
            <a href="/about.html">About</a>
            <a href="/contact.html">Contact</a>
        </div>
    </nav>

    <main>
        <section class="hero">
            <!-- Indic numeral column - descending from 5 to 2 -->
            <div class="indic-column" aria-hidden="true">
                <span class="indic-num kannada-5">‡≥´</span>
                <span class="indic-num devanagari-4">‡•™</span>
                <span class="indic-num sharada-3">ëáì</span>
                <img src="/images/irendu2.png" alt="" class="indic-num irendu-2">
            </div>

            <!-- Multicoloured neon watermark -->
            <div class="neon-watermark" aria-hidden="true">
                <span class="wm-left">a</span>
                <span class="wm-four">4</span>
                <span class="wm-right">‡ÆÆ‡ØÅ‡Æ≤satyasya</span>
            </div>

            <div class="hero-content">
                <h1 class="title">
                    <!-- Background watermark: 4 ‡ÆÆ‡ØÇ‡Æ≤ ‡§∏‡§§‡•ç transitioning green‚Üípink -->
                    <span class="bg-watermark" aria-hidden="true">
                        <span class="bg-four">4</span>
                        <span class="bg-mula">‡ÆÆ‡ØÇ‡Æ≤</span>
                        <span class="bg-sat">‡§∏‡§§‡•ç</span>
                    </span>
                    <span class="title-wrapper">
                        <span class="title-text">a formulation of truth</span>
                        <span class="title-flicker" aria-hidden="true">a formulation of truth</span>
                    </span>
                </h1>

                <!-- Full-width Buddha glitch video -->
                <div class="fullwidth-video-container">
                    <video class="fullwidth-video" autoplay muted loop playsinline>
                        <source src="/videos/buddha_glitch.MOV" type="video/quicktime">
                        <source src="/videos/buddha_glitch.MOV" type="video/mp4">
                    </video>
                    <div class="video-scanlines"></div>
                    <div class="fullwidth-scroll">
                        <p class="sanskrit">‡§ï‡•ç‡§≤‡•á‡§∂‡§æ‡§®‡•ç ‡§µ‡§ø‡§®‡§æ‡§∂‡§Ø ‡§µ‡§ø‡§ï‡§æ‡§∏‡§Ø ‡§π‡•É‡§§‡•ç‡§∏‡§∞‡•ã‡§ú‡§Æ‡•ç</p>
                        <p class="sanskrit">‡§ì‡§ú‡•ã ‡§µ‡§ø‡§ú‡•É‡§Æ‡•ç‡§≠‡§Ø ‡§®‡§ø‡§ú‡§Ç ‡§®‡§ø‡§ú‡§®‡§æ‡§∞‡•ç‡§•‡§Ø‡§æ‡§ô‡•ç‡§ó‡§Æ‡•ç ‡•§</p>
                        <p class="sanskrit">‡§ö‡•á‡§§‡§∂‡•ç‡§ö‡§ï‡•ã‡§∞‡§ö‡§ø‡§§‡•ç‡§§‡§ö‡§®‡•ç‡§¶‡•ç‡§∞‡§Æ‡§∞‡•Ä‡§ö‡§ø‡§ö‡§ï‡•ç‡§∞‡§Æ‡•ç</p>
                        <p class="sanskrit">‡§Ü‡§ö‡§Æ‡•ç‡§Ø ‡§∏‡§Æ‡•ç‡§Ø‡§ó‡§Æ‡•É‡§§‡§Ç ‡§ï‡•Å‡§∞‡•Å ‡§µ‡§ø‡§∂‡•ç‡§µ‡§Æ‡•á‡§§‡§§‡•ç ‡••</p>
                        <p class="translation">Destroy afflictions and cause to blossom the lotus in the heart; may awareness, your innate radiance with body fit for purpose, feast upon consciousness cool as moonbeams.* And may your recognition transform this world into a place of eternal remembrance and awakening.</p>
                        <p class="attribution">‚Äî Utpaladeva (c. 900‚Äì950 CE)</p>
                    </div>
                    <!-- Footnote hover on cakora reference -->
                    <div class="trident-hover" style="position: absolute; bottom: 10%; left: 3%;">
                        <span class="trident-trigger" title="About the cakora">‚ú¶</span>
                        <div class="trident-popup">
                            * The original Sanskrit refers to the <a href="https://en.wikipedia.org/wiki/Chakora_(mythology)" target="_blank" rel="noopener">cakora</a> (‡§ö‡§ï‡•ã‡§∞), a mythical bird in Sanskrit poetry said to fly only at night and subsist entirely on moonbeams. I have omitted the cakora here as the metaphor has lost broader cultural resonance, but wish the reader to know this is an intentional departure from the original. The cakora's longing gaze toward the moon became a beloved trope for yearning after and devotion to the divine. In the 10th century CE, poets like Utpaladeva very likely conceptualized the divine in ways far healthier than we who find ourselves imbricated within the cultural and political contexts of modernity‚Äîits corrupt power struggles, its flattened metaphysics, its instrumentalized faith that have defined our age.
                        </div>
                    </div>
                </div>
               <!-- <div class="cta-group">
                    <a href="#begin" class="cta cta-primary">‡Æ§‡Øä‡Æü‡Æô‡Øç‡Æï‡ØÅ<br><span style="font-variant: small-caps; font-size: 0.7em; letter-spacing: 0.1em;">begin</span></a>
                </div>-->
            </div>
            <div class="scroll-indicator">
                <span></span>
            </div>
        </section>

        <!-- Encryption info hover tooltip -->
        <div class="encryption-hover">
            <span class="encryption-trigger">üîê</span>
            <div class="encryption-popup">
                This application uses AES-256-GCM to encrypt at rest‚Äîboth prior to and in storage‚Äîeach word you type. Over many iterations the code rendering the pages of this website is developed <em>not to collect</em> personally identifiable information (PII). Here assured any data you do submit will not be sold. Do reach out via email with any comments, the discovery of a bug, questions, or simply to say hi. Thanks for visiting and have fun.
            </div>
        </div>

        <section id="begin" class="section gate-section">
            <div class="gate-content">
                <img src="/images/irendu2.png" alt="irendu ‚Äî Tamil for 'two'" class="gate-icon" title="irendu ‚Äî Tamil for 'two'">
                <!-- Gate Title: Tamil + English -->
                <h2 class="gate-title gate-title--tamil">‡Æµ‡Ææ‡ÆØ‡Æø‡Æ≤‡Øç</h2>
                <h2 class="gate-title gate-title--english">here, we meet <a href="#begin">(a)gate</a></h2>

                <!-- Welcome Text: Tamil -->
                <p class="gate-description gate-welcome--tamil tamil-text">
                    Proust ‡Æï‡Øá‡Æ≥‡Øç‡Æµ‡Æø‡Æ§‡Øç‡Æ§‡Ææ‡Æ≥‡Øç‚Äî‡Æï‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡Æö‡Ææ‡ÆÆ‡Æø ‡Æï‡Øá‡Æ≥‡Øç‡Æµ‡Æø‡Æ§‡Øç‡Æ§‡Ææ‡Æ≥‡Øç ‡Æé‡Æ©‡Øç‡Æ± ‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Æø‡Æ≤‡Øç‚Äî‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øà ‡Æµ‡Æ∞‡Æµ‡Øá‡Æ±‡Øç‡Æï‡Æø‡Æ±‡Æ§‡ØÅ
                </p>
                <!-- Welcome Text: Transliteration -->
                <p class="gate-description gate-welcome--translit" style="font-size: 0.7rem; color: var(--mist); font-style: italic; margin-top: -1rem;">
                    Proust kƒì·∏∑vittƒÅ·∏∑‚ÄîKaruppacƒÅmi kƒì·∏∑vittƒÅ·∏∑ e·πâ·πüa peyaril‚Äîu·πÖka·∏∑ai varavƒì·πüki·πüatu
                </p>
                <!-- Welcome Text: English -->
                <p class="gate-description gate-welcome--english">
                    The Proust Questionnaire‚Äîunder the name Karuppasami Questionnaire‚Äîwelcomes you
                </p>
                <!-- Welcome Text: Spanish -->
                <p class="gate-description gate-welcome--spanish">
                    El Cuestionario de Proust‚Äîbajo el nombre Cuestionario Karuppasami‚Äîte da la bienvenida
                </p>

                <!-- Language Display Selector -->
                <div class="a4m-lang-selector" role="group" aria-label="Question display language">
                    <span class="a4m-lang-selector__label">‡ÆÆ‡Øä‡Æ¥‡Æø</span>
                    <div class="a4m-lang-selector__options">
                        <button type="button" class="a4m-lang-selector__btn" data-lang="all" aria-pressed="true" title="tamil + Transliteration + English">
                            <span class="a4m-lang-selector__icon">‡Æ§</span>
                            <span class="a4m-lang-selector__text">+Tr</span>
                        </button>
                        <button type="button" class="a4m-lang-selector__btn" data-lang="tamil-only" aria-pressed="false" title="tamil only">
                            <span class="a4m-lang-selector__icon">‡Æ§</span>
                        </button>
                        <button type="button" class="a4m-lang-selector__btn" data-lang="tamil-translit" aria-pressed="false" title="tamil + Transliteration">
                            <span class="a4m-lang-selector__icon">‡Æ§</span>
                            <span class="a4m-lang-selector__text">+Aa</span>
                        </button>
                        <button type="button" class="a4m-lang-selector__btn" data-lang="english-only" aria-pressed="false" title="English only">
                            <span class="a4m-lang-selector__icon">En</span>
                        </button>
                        <button type="button" class="a4m-lang-selector__btn" data-lang="spanish-only" aria-pressed="false" title="Spanish only">
                            <span class="a4m-lang-selector__icon">Es</span>
                        </button>
                    </div>
                </div>

                <form class="gate-form" id="gate-form">
                    <!-- Gate Question 1: Perfect Happiness -->
                    <div class="form-group">
                        <label for="answer1" class="trilingual-label">
                            <span class="question-number">‡Øß</span>
                            <span class="question-layers">
                                <!-- Primary: Tamil script -->
                                <span class="question-tamil" lang="ta">
                                    ‡ÆÆ‡ØÅ‡Æ¥‡ØÅ‡ÆÆ‡Øà‡ÆØ‡Ææ‡Æ© ‡ÆÆ‡Æï‡Æø‡Æ¥‡Øç‡Æö‡Øç‡Æö‡Æø ‡Æé‡Æ©‡Øç‡Æ±‡Ææ‡Æ≤‡Øç ‡Æâ‡Æ©‡Æï‡Øç‡Æï‡ØÅ ‡Æé‡Æ©‡Øç‡Æ©?
                                </span>
                                <!-- Secondary: Transliteration -->
                                <span class="question-transliteration" lang="ta-Latn">
                                    Mu·∏ªumaiyƒÅ·πâa maki·∏ªcci e·πâ·πüƒÅl u·πâakku e·πâ·πâa?
                                </span>
                                <!-- Tertiary: English -->
                                <span class="question-english">
                                    What is your idea of perfect happiness?
                                </span>
                                <!-- Quaternary: Spanish -->
                                <span class="question-spanish" lang="es">
                                    ¬øCu√°l es tu idea de la felicidad perfecta?
                                </span>
                            </span>
                        </label>
                        <textarea
                            id="answer1"
                            name="answer1"
                            placeholder="Take your time..."
                            aria-describedby="accessibility-hint"
                        ></textarea>
                    </div>

                    <!-- Gate Question 2: Greatest Fear -->
                    <div class="form-group">
                        <label for="answer2" class="trilingual-label">
                            <span class="question-number">‡Ø®</span>
                            <span class="question-layers">
                                <!-- Primary: Tamil script -->
                                <span class="question-tamil" lang="ta">
                                    ‡Æâ‡Æ©‡Øç‡Æ©‡ØÅ‡Æü‡Øà‡ÆØ ‡ÆÆ‡Æø‡Æï‡Æ™‡Øç‡Æ™‡ØÜ‡Æ∞‡Æø‡ÆØ ‡ÆÖ‡Æö‡Øç‡Æö‡ÆÆ‡Øç ‡ÆØ‡Ææ‡Æ§‡ØÅ?
                                </span>
                                <!-- Secondary: Transliteration -->
                                <span class="question-transliteration" lang="ta-Latn">
                                    U·πâ·πâu·π≠aiya mikapperiya accam yƒÅtu?
                                </span>
                                <!-- Tertiary: English -->
                                <span class="question-english">
                                    What is your greatest fear?
                                </span>
                                <!-- Quaternary: Spanish -->
                                <span class="question-spanish" lang="es">
                                    ¬øCu√°l es tu mayor temor?
                                </span>
                            </span>
                        </label>
                        <textarea
                            id="answer2"
                            name="answer2"
                            placeholder="Or leave unanswered..."
                        ></textarea>
                    </div>

                    <div class="form-group email-section">
                        <label for="email">
                            Enter your email to receive a magic link
                        </label>
                        <input
                            type="email"
                            id="email"
                            name="email"
                            placeholder="your@email.com"
                            required
                            autocomplete="email"
                        >
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="submit-btn" id="submit-btn">
                            Continue to Questionnaire
                        </button>
                    </div>

                    <div class="status-message" id="status-message"></div>

                    <p class="accessibility-note" id="accessibility-hint">
                        For voice input, use <a href="https://github.com/cjpais/Handy" target="_blank" rel="noopener">Handy</a> ‚Äî free offline speech-to-text
                    </p>

                    <p class="encryption-note">
                        Responses encrypted with age (X25519) before storage
                    </p>
                </form>
            </div>
        </section>
    </main>

    <footer>
        <div class="footer-inner">
            <div class="footer-links">
                <a href="/about.html">About</a>
                <a href="/contact.html">Contact</a>
                <a href="/privacy.html">Privacy</a>
            </div>
            <p class="footer-copy">
                Hosted with zero logs in Iceland
            </p>
        </div>
    </footer>

    <script>
        // Smooth scroll for anchor links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function(e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            });
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // A4M Language Selector ‚Äî ‡ÆÆ‡Øä‡Æ¥‡Æø (Mo·∏ªi)
        // Persists preference to localStorage
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        (function initLangSelector() {
            const STORAGE_KEY = 'a4m-lang-mode';
            const gateContent = document.querySelector('.gate-content');
            const buttons = document.querySelectorAll('.a4m-lang-selector__btn');

            if (!gateContent || !buttons.length) return;

            // Restore saved preference
            const savedMode = localStorage.getItem(STORAGE_KEY) || 'all';
            setLangMode(savedMode);

            // Handle button clicks
            buttons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const mode = this.dataset.lang;
                    setLangMode(mode);
                    localStorage.setItem(STORAGE_KEY, mode);
                });
            });

            function setLangMode(mode) {
                // Update data attribute on gate-content (CSS uses this for visibility)
                gateContent.dataset.langMode = mode;

                // Update aria-pressed states
                buttons.forEach(btn => {
                    btn.setAttribute('aria-pressed', btn.dataset.lang === mode);
                });
            }
        })();

        // Form handling
        const form = document.getElementById('gate-form');
        const submitBtn = document.getElementById('submit-btn');
        const statusMessage = document.getElementById('status-message');

        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status-message visible ${type}`;
        }

        function hideStatus() {
            statusMessage.className = 'status-message';
        }

        function setButtonState(state, text) {
            submitBtn.textContent = text;
            submitBtn.className = `submit-btn ${state}`;
            submitBtn.disabled = state === 'loading';
        }

        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            hideStatus();

            const email = document.getElementById('email').value.trim();
            const answer1 = document.getElementById('answer1').value.trim();
            const answer2 = document.getElementById('answer2').value.trim();

            // Validate email
            if (!email) {
                showStatus('Please enter your email address', 'error');
                return;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showStatus('Please enter a valid email address', 'error');
                return;
            }

            // Build gate answers array
            const gateAnswers = [];
            if (answer1) {
                gateAnswers.push({
                    question: 'What is your idea of perfect happiness?',
                    answer: answer1
                });
            }
            if (answer2) {
                gateAnswers.push({
                    question: 'What is your greatest fear?',
                    answer: answer2
                });
            }

            // Update UI - encrypting
            setButtonState('loading', 'Encrypting...');
            showStatus('Securing your responses...', 'info');


            // Small delay for UX
            await new Promise(resolve => setTimeout(resolve, 800));

            // Update UI - sending
            setButtonState('loading', 'Sending magic link...');
            showStatus('Requesting magic link...', 'info');

            try {
                const response = await fetch('/api/auth/magic-link', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email })
                });

                // Safely parse JSON - handle empty responses
                let data = {};
                const text = await response.text();
                if (text) {
                    try {
                        data = JSON.parse(text);
                    } catch (parseError) {
                        console.error('Failed to parse response:', text);
                    }
                }

                if (response.ok) {
                    setButtonState('success', 'Magic link sent!');
                    showStatus('Check your inbox for your magic link to continue the questionnaire.', 'success');

                    // Clear form but keep answers in sessionStorage
                    form.reset();

                    // Reset button after delay
                    setTimeout(() => {
                        setButtonState('', 'Continue to Questionnaire');
                    }, 5000);
                } else {
                    // Clear stored answers on error
                    sessionStorage.removeItem('pendingGateAnswers');
                    throw new Error(data.error || 'Failed to send magic link');
                }
            } catch (error) {
                console.error('Submission error:', error);
                sessionStorage.removeItem('pendingGateAnswers');
                setButtonState('', 'Continue to Questionnaire');
                showStatus(error.message || 'Something went wrong. Please try again.', 'error');
            }
        });

        // Intersection Observer for scroll animations
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.opacity = '1';
                    entry.target.style.transform = 'translateY(0)';
                }
            });
        }, observerOptions);

        // Observe sections for fade-in
        document.querySelectorAll('.section-inner, .gate-content').forEach(el => {
            el.style.opacity = '0';
            el.style.transform = 'translateY(30px)';
            el.style.transition = 'opacity 0.8s ease, transform 0.8s ease';
            observer.observe(el);
        });

        // DISABLED: Play poem audio on first mouse movement (bypasses autoplay restrictions)
        // Plays once, pauses 10s, plays once more, then stops
        /*
        const poemAudio = document.getElementById('poem-audio');
        let audioStarted = false;
        let playCount = 0;

        function startAudioOnInteraction() {
            if (audioStarted || !poemAudio) return;
            audioStarted = true;

            // When audio ends, handle the pause-and-replay logic
            poemAudio.addEventListener('ended', function handleEnded() {
                playCount++;
                if (playCount === 1) {
                    // First play finished - wait 10 seconds, then play again
                    setTimeout(() => {
                        poemAudio.currentTime = 0;
                        poemAudio.play().catch(err => {
                            console.log('Second play failed:', err);
                        });
                    }, 10000);
                } else {
                    // Second play finished - done, remove listener
                    poemAudio.removeEventListener('ended', handleEnded);
                    console.log('Poem recitation complete');
                }
            });

            poemAudio.play().then(() => {
                console.log('Poem recitation started');
            }).catch(err => {
                console.log('Audio play failed:', err);
                audioStarted = false; // Allow retry on next interaction
            });

            // Remove listeners after successful start
            if (audioStarted) {
                document.removeEventListener('mousemove', startAudioOnInteraction);
                document.removeEventListener('touchstart', startAudioOnInteraction);
            }
        }

        document.addEventListener('mousemove', startAudioOnInteraction, { once: false });
        document.addEventListener('touchstart', startAudioOnInteraction, { once: false });
        */
    </script>
</body>
</html>
