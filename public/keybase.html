<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Keybase Login — a formulation of truth</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;800&family=Noto+Sans+Tamil:wght@400;700&family=Noto+Sans+Devanagari:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root{ --neon-cyan:#00ffff; --neon-pink:#ff2aff; --bg:#0c0720; }
  *{box-sizing:border-box;margin:0;padding:0}
  body{min-height:100vh;background:linear-gradient(180deg,#050214,#0c0720); color:#e7e1ff; font-family: "Noto Sans Tamil", "Orbitron", system-ui; display:flex; align-items:center; justify-content:center; padding:2rem}
  .panel{width:100%;max-width:720px;background:rgba(6,6,18,0.66);border-radius:14px;padding:2.2rem;border:1px solid rgba(0,255,255,0.08);box-shadow:0 20px 50px rgba(0,0,0,0.6)}
  h2{font-family:Orbitron,sans-serif;margin-bottom:0.6rem;color:#fff}
  p.muted{color:#cfc7ff;opacity:0.9;margin-bottom:1rem}
  .email-centered {
    width:100%;
    padding:14px 16px;
    border-radius:12px;
    border:2px solid rgba(0,255,255,0.08);
    background: rgba(0,0,0,0.36);
    text-align:center; /* centered email */
    font-family: monospace;
    font-size:1rem;
    color:#fff;
    margin-bottom:0.85rem;
  }
  .controls{display:flex;gap:0.75rem;flex-wrap:wrap}
  .btn{padding:10px 14px;border-radius:10px;border:2px solid var(--neon-cyan);background:transparent;color:var(--neon-cyan);font-weight:700;cursor:pointer;text-decoration:none}
  .btn.keybase{border-color:var(--neon-pink);color:var(--neon-pink)}
  .hint{margin-top:1rem;color:#e2dff8;font-size:0.95rem}
  .err{color:#ffbdbd;margin-top:0.6rem}
</style>
</head>
<body>
  <div class="panel" role="main" aria-labelledby="kb-title">
    <h2 id="kb-title">Keybase / Token Login</h2>
    <p class="muted">You must have entered your email on the previous page. If you didn't, you'll be redirected back.</p>

    <div id="emailBox" class="email-centered" aria-live="polite">Loading…</div>

    <div class="controls">
      <a id="openKeybase" class="btn keybase" href="#" target="_blank" rel="noopener">Open Keybase Chat (opens app)</a>
      <button id="pasteToken" class="btn">Paste token & Verify</button>
      <button id="logout" class="btn" style="border-color:rgba(255,255,255,0.06);color:#dcd1ff">Start Over</button>
    </div>

    <div style="margin-top:12px">
      <form id="tokenForm">
        <input id="tokenInput" type="text" placeholder="Paste Keybase token here" style="width:100%;padding:12px;margin-top:8px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:rgba(0,0,0,0.36);color:#fff" />
        <div style="margin-top:8px;display:flex;gap:8px">
          <button type="submit" class="btn">Verify token</button>
          <span style="align-self:center;color:#cfc7ff;font-size:0.92rem">or wait for magic link from email</span>
        </div>
      </form>
    </div>

    <div id="status" class="hint"></div>
    <div id="error" class="err" role="alert" style="display:none"></div>
  </div>

<script>
  // page requires sessionStorage 'a4m_user_email'
  (function(){
    try {
      const email = sessionStorage.getItem('a4m_user_email');
      if (!email) {
        // If not present, redirect back to index
        window.location.href = '/';
        return;
      }
      const emailBox = document.getElementById('emailBox');
      emailBox.textContent = email; // centered by CSS
      // open keybase link to chat a4ot_bot (native protocol)
      document.getElementById('openKeybase').href = 'keybase://chat/a4ot_bot';
      document.getElementById('pasteToken').addEventListener('click', async () => {
        // try reading clipboard (permission may be required)
        try {
          const text = await navigator.clipboard.readText();
          if (text) {
            document.getElementById('tokenInput').value = text;
            document.getElementById('status').textContent = 'Pasted from clipboard. Click "Verify token".';
          } else {
            document.getElementById('status').textContent = 'Clipboard empty.';
          }
        } catch (err) {
          document.getElementById('status').textContent = 'Unable to access clipboard (permissions denied). Paste manually.';
        }
      });

      document.getElementById('tokenForm').addEventListener('submit', async (ev) => {
        ev.preventDefault();
        const token = document.getElementById('tokenInput').value.trim();
        if (!token) {
          document.getElementById('error').style.display='block';
          document.getElementById('error').textContent = 'Please paste the Keybase token you received.';
          return;
        }
        document.getElementById('status').textContent = 'Verifying…';
        document.getElementById('error').style.display='none';
        try {
          const res = await fetch('/api/auth/keybase-verify', {
            method:'POST',
            headers:{ 'Content-Type':'application/json' },
            body: JSON.stringify({ token, email: sessionStorage.getItem('a4m_user_email') })
          });
          const data = await res.json().catch(()=>null);
          if (res.ok && data && data.success) {
            document.getElementById('status').textContent = 'Authentication successful — redirecting…';
            setTimeout(()=> window.location.href = data.redirect || '/questionnaire', 900);
          } else {
            document.getElementById('error').style.display='block';
            document.getElementById('error').textContent = (data && data.error) ? data.error : 'Verification failed.';
            document.getElementById('status').textContent = '';
          }
        } catch (err) {
          document.getElementById('error').style.display='block';
          document.getElementById('error').textContent = 'Network error verifying token.';
          document.getElementById('status').textContent = '';
        }
      });

      document.getElementById('logout').addEventListener('click', ()=> {
        try { sessionStorage.removeItem('a4m_user_email'); } catch(e){}
        window.location.href = '/';
      });

    } catch (err) {
      // on any fatal, bounce back to root
      console.error(err);
      window.location.href = '/';
    }
  })();
</script>

</body>
</html>

